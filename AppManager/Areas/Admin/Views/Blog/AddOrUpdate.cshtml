@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Dashboard";
    string error = TempData["error"] as string;
}

<section class="content-header">
    <h1>
        &nbsp;
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="#">Blog</a></li>
        <li class="active">Quản lý bài viết</li>
    </ol>
</section>

<section class="content">
    <div class="row">
    <div class="col-md-3">
        <div class="box box-primary">
            <div class="box-body box-profile" id="author-info">
                
            </div>
        </div>
    </div>
    <!-- /.col -->
    <div class="col-md-9">
        <div class="box box-primary">
            <form method="post" action="/Admin/Blog/AddOrUpdate">
                <div class="box-header with-border">
                    <h3 class="box-title">Quản lý bài viết</h3>
                </div>
                <div class="box-body">
                        <input type="text" name="id" value="@(Model == null ? 0 : @Model.Id)" hidden />
                        <input type="text" name="avatarId" id="image-file-id" value="@(Model == null ? 0 : @Model.AvatarId)" hidden />
                        <input type="text" name="avatar" id="image-file-path" value="@(Model == null ? "" : @Model.Avatar)" hidden />
                        <input type="text" name="status" id="post-status" value="@(Model == null ? 0 : @Model.Status)" hidden />
                        <input type="text" name="categoryId" id="category-id" value="@(Model == null ? 0 : @Model.CategoryId)" hidden />
                        <div class="form-group">
                            <input class="form-control" placeholder="Tiêu đề:" value="@(Model == null ? "" : Model.Title)" name="title">
                        </div>
                        <div class="form-group">
                            <input class="form-control" placeholder="Description:" value="@(Model == null ? "" : Model.Description)" name="description">
                        </div>
                        <div class="form-group">
                            <textarea id="txt-content" value="@(Model == null ? "" : Html.Raw(Model.Content))" class="form-control" style="height: 300px" name="content">
                            </textarea>
                        </div>
                        <div class="form-group">
                            <select class="form-control select2" id="category-blog" style="width: 100%;">
                            </select>
                        </div>
                        <div class="form-group">
                            @{
                                var tags = "";
                                if (Model != null)
                                {
                                    foreach(var tag in Model.Tag)
                                    {
                                        tags += tag + ", ";
                                    }
                                }
                                tags = tags.Substring(0, Math.Max(0, tags.Length - 2));
                            }
                            <input class="form-control" placeholder="Tags:" value="@tags" name="tag">
                        </div>
                        <div class="form-group">
                              <label for="exampleInputFile">Ảnh đại diện</label>
                              <input type="file" id="image-upload" name="fileUpload">
                              <p class="help-block">Chọn ảnh đại diện cho bài viết</p>
                        </div>
                </div>
                <!-- /.box-body -->
                <div class="box-footer">
                    <div class="pull-right">
                        <button type="button" class="btn btn-default btnsubmit" name="save"><i class="fa fa-pencil"></i> Lưu bản nháp</button>
                        <button type="submit" class="btn btn-primary btnsubmit" name="submit"><i class="fa fa-envelope-o"></i> Gửi đi</button>
                    </div>
                    <button type="reset" class="btn btn-default btnsubmit" name="delete"><i class="fa fa-times"></i> Huỷ</button>
                </div>

            </form>
        <!-- /.box-footer -->
        </div>
        <!-- /. box -->
    </div>
    <!-- /.col -->
    </div>
    <!-- /.row -->
</section>

@section Scripts{
    <script>
        ClassicEditor
            .create( document.querySelector( '#txt-content' ) )
            .catch( error => {
                console.error( error );
            } );
    
      

        $(document).ready(function (){
            $(document).on('click', '.btnsubmit', function() {
                btn = $(this).attr('name');
                console.log(btn);
            })
        });

        $(document).on('change', 'input[name="fileUpload"]', function() {
            let files = $(this).prop("files");
            let formData = new FormData();
            formData.append("file", files[0]);
            $.ajax({
                url: "/admin/blog/uploadfile",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                beforeSend: () => {

                },
                success: res => {
                    console.log(res);
                    $('#image-upload').attr('src', res.fileInfo.filePath);
                    $('#image-file-path').val(res.fileInfo.filePath);
                    $('#image-file-id').val(res.fileInfo.id);
                },
                error: error => {
                    console.log(error);
                }
            })
        });

        $.ajax({
            url: "/Admin/Blog/AuthorInfo",
            type: "GET",
            dataType: "json",
            beforeSend: function(){},
            success: function(data){
                console.log(data);
                let html = `<img class="profile-user-img img-responsive img-circle" src="${data.avatar}" alt="User profile picture">
                            <h3 class="profile-username text-center">${data.authorName}</h3>
                            <p class="text-muted text-center">${data.authorRole}</p>`
                $('#author-info').append(html);                
            },
            error: function(){
                console.log("error!");
            },
            complete: function(){}
        });


        $.ajax({
            url: "/Blog/GetCategoryBlog",
            type: "GET",
            dataType: "json",
            beforeSend: function(){},
            success: function(data){
                console.log(data);
                data.forEach(function(item,index){
                    let html = `<option id="${item.id}">${item.name}</option>`;
                    
                    $('#category-blog').append(html);  
                });          
            },
            error: function(){
                console.log("error!");
            },
            complete: function(){}
        });

        $('#category-blog').on('change', function(){
            $('#category-id').val($("#category-blog :selected").attr("id"));
            console.log($("#category-id").val());
        });
        
        //$(document).ready(function (){
        //    CKFinder.setupCKEditor();
        //    var editor = CKEDITOR.replace('txt-content', {
        //        customConfig: '/admin/plugins/ckeditor/config.js',          
        //    });
        //});

    </script>
}